# 胜率异常高原因分析

## 🔍 问题概述

### 核心问题
**Non-Overlap胜率异常高（96-100%），不符合正常市场规律**

### 观察到的胜率
- **CatBoost Top 5-15**: 96% (24/25期盈利)
- **LambdaRank Top 5-15**: 100% (25/25期盈利)
- **正常市场预期**: 50-60%胜率

---

## 📊 胜率计算方式

### 定义
```python
win_rate = (period_returns > 0).mean()
```
- **胜率** = 收益为正的期间数 / 总期间数
- **期间**: 每10天一个持有期（Non-Overlap）
- **总期数**: 25期（2025-01-02 至 2025-12-17）

### 计算逻辑
1. 每个持有期（10天）计算Top N股票的平均收益
2. 如果该期收益 > 0，记为"盈利"
3. 如果该期收益 ≤ 0，记为"亏损"
4. 胜率 = 盈利期数 / 总期数

---

## 🎯 胜率异常高的根本原因

### 1. **数据质量问题导致每期收益都为正**

#### 问题链条
1. **价格数据异常** → 某些股票的Close价格异常（$0.00或异常高）
2. **Target计算异常** → 这些异常价格导致target值异常高（>50%甚至>100%）
3. **模型选择异常值** → 模型预测这些异常值股票的分数高，被选入Top N
4. **每期收益异常高** → Top N平均收益达到20-50%（正常应该<5%）
5. **胜率异常高** → 由于每期收益都为正，胜率接近100%

#### 具体证据
- **CatBoost**: 24期盈利（20-50%），1期亏损（-0.11%）
- **LambdaRank**: 25期全部盈利（27-49%）
- **正常市场**: 10天持有期收益通常在 -5% 到 +5% 之间，胜率应该在50-60%

### 2. **异常值被模型有效选择**

#### 模型预测能力
- **CatBoost IC**: 0.9308（非常高）
- **LambdaRank IC**: 0.7614（很高）
- **Rank IC**: 0.9552（CatBoost）和 0.6654（LambdaRank）

#### 问题
- 模型预测能力确实很强（IC高）
- **但模型预测的是异常值**（target值异常高）
- 模型能够有效识别这些异常值，并将其选入Top N
- 导致每期收益都异常高，胜率接近100%

### 3. **异常值分布导致胜率异常高**

#### 异常值统计
- **Target > 50%**: 11,312个样本（0.27%）
- **最高target**: 48,739,999%（4.87亿%！）
- **主要来源**: `SOLS` ticker（价格从$0.00跳到$7.60）

#### 影响
- 虽然异常值只占0.27%，但模型能够有效识别它们
- 每期Top N选择中，至少有几个异常值被选中
- 这些异常值的高收益（>50%）足以让整期收益为正
- 即使其他股票收益正常或为负，异常值的高收益也能"掩盖"亏损

---

## 📈 详细分析

### CatBoost 胜率分析

| 期数 | 期收益 | 状态 | 说明 |
|------|--------|------|------|
| 1-24 | 27-46% | ✅ 盈利 | 每期都包含异常值 |
| 25 | -0.11% | ❌ 亏损 | 唯一亏损期（可能异常值较少） |

**胜率**: 24/25 = **96%**

### LambdaRank 胜率分析

| 期数 | 期收益 | 状态 | 说明 |
|------|--------|------|------|
| 1-25 | 27-49% | ✅ 盈利 | 每期都包含异常值 |

**胜率**: 25/25 = **100%**

### 正常市场对比

| 指标 | 正常市场 | 当前数据 | 差异 |
|------|----------|----------|------|
| 10天期收益 | -5% 到 +5% | 20-50% | **4-10倍** |
| 胜率 | 50-60% | 96-100% | **+36-50%** |
| 异常高收益（>30%） | <0.1% | 1.22% | **12倍** |

---

## 🔧 根本原因总结

### 核心问题
**数据质量问题导致异常值被模型有效选择，进而导致每期收益都为正，胜率异常高**

### 问题链条
1. **价格数据异常** → $0.00价格、异常高价格
2. **Target值异常** → 11,312个样本target > 50%
3. **模型选择异常值** → IC高，能有效识别异常值
4. **每期收益异常高** → 20-50%（正常<5%）
5. **胜率异常高** → 96-100%（正常50-60%）

### 关键发现

1. **异常值虽然少（0.27%），但影响巨大**
   - 11,312个异常样本（target > 50%）
   - 模型能够有效识别并选择这些异常值
   - 每期Top N中至少有几个异常值被选中

2. **异常值的高收益"掩盖"了正常股票的亏损**
   - 即使其他股票收益正常或为负
   - 异常值的高收益（>50%）足以让整期收益为正
   - 导致胜率接近100%

3. **模型预测能力确实强，但预测的是异常值**
   - IC和Rank IC都很高
   - 但模型预测的是异常值（target值异常高）
   - 如果数据质量正常，模型表现可能会不同

---

## 📝 解决方案

### 1. **数据清洗（优先级最高）**

#### 价格数据清洗
- 移除异常高价格（> $10,000，除非是正常的高价股）
- 处理$0.00价格（可能是停牌或数据错误）
- 处理异常价格变动（>100%或<-90%）
- 检查股票拆分/合并是否正确处理

#### Target值清洗
- **Winsorization**: 将target值截尾到合理范围（如-50%到+50%）
- 移除异常target值（>100%或<-90%）
- 检查并修复价格从$0.00跳变的情况

### 2. **重新训练和评估**

#### 数据文件重新生成
- 使用清洗后的价格数据
- 重新计算所有因子
- 重新计算target值（使用winsorization）

#### 模型重新训练
- 使用清洗后的数据文件
- 重新训练所有模型
- 重新评估80/20 split

### 3. **验证结果**

#### 预期改善
- **期收益**: 从20-50%降至正常范围（-5%到+5%）
- **胜率**: 从96-100%降至正常范围（50-60%）
- **异常值影响**: 显著降低

---

## 🎯 结论

### 胜率异常高的根本原因

**数据质量问题**: 价格数据中存在大量异常值（$0.00价格、异常高价格），导致target值异常高。模型能够有效识别并选择这些异常值，导致每期收益都为正（20-50%），胜率异常高（96-100%）。

### 关键发现

1. **异常值虽然少（0.27%），但影响巨大**
   - 11,312个异常样本（target > 50%）
   - 模型能够有效识别并选择这些异常值
   - 每期Top N中至少有几个异常值被选中

2. **异常值的高收益"掩盖"了正常股票的亏损**
   - 即使其他股票收益正常或为负
   - 异常值的高收益（>50%）足以让整期收益为正
   - 导致胜率接近100%

3. **模型预测能力确实强，但预测的是异常值**
   - IC和Rank IC都很高
   - 但模型预测的是异常值（target值异常高）
   - 如果数据质量正常，模型表现可能会不同

### 建议

1. **立即清洗数据**: 处理价格异常值，重新计算target（使用winsorization）
2. **重新生成数据文件**: 使用清洗后的数据
3. **重新训练模型**: 使用清洗后的数据文件
4. **验证结果**: 在真实历史数据上测试（如2023-2024年）

---

**生成时间**: 2025-01-20  
**状态**: ⚠️ **需要数据清洗和重新训练**
