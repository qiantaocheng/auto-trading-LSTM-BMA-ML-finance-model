# 子集采样方式分析

## 关键发现

**子集是按ticker采样，不是按时间采样！**

### 数据对比

| 指标 | 全量数据 | 子集数据 | 比例 |
|------|---------|---------|------|
| **Ticker数量** | 3,921 | 784 | **20.0%** (1/5) |
| **唯一日期数** | 1,244 | 1,244 | **100%** (完全相同) |
| **日期范围** | 2021-01-19 到 2025-12-30 | 2021-01-19 到 2025-12-30 | **完全相同** |
| **平均每个ticker样本数** | 1,066.2 | 1,056.0 | 99.05% (几乎相同) |
| **总样本数** | ~4,180,000 | ~827,900 | **19.8%** |

### 采样方式

```python
# 从 create_subset_1_5_tickers.py Line 44-66
# 1. 获取所有唯一的ticker
all_tickers = df.index.get_level_values('ticker').unique()

# 2. 随机选择1/5的ticker
selected_tickers = np.random.choice(all_tickers, size=n_subset_tickers, replace=False)

# 3. 过滤数据，只保留选中的ticker
mask = ticker_level.isin(selected_tickers)
df_subset = df[mask].copy()
```

**关键点**：
- ✅ **日期范围完整**：子集包含所有1244个交易日
- ✅ **每个ticker数据完整**：选中的ticker有完整的时间序列
- ❌ **Ticker数量减少**：从3921个减少到784个（1/5）

## 对训练的影响

### 1. CV Fold训练窗计算

**好消息**：日期范围完整，所以：
- 每个CV fold的训练窗天数应该和全量数据相同
- 不应该因为训练窗不足252天而跳过fold

**但是**：可能存在的问题：
- 虽然日期范围完整，但**每个日期的样本数减少了80%**
- 每个fold的训练数据中，**ticker数量只有原来的1/5**
- 这可能导致某些计算或模型训练出现问题

### 2. 为什么可能仍然挂起？

虽然日期范围完整，但可能的问题：

1. **数据稀疏性**：
   - 每个日期的样本数从 ~3,360 减少到 ~665
   - 某些日期可能样本数不足，导致CV fold数据不足

2. **Ticker多样性不足**：
   - 每个fold只有784个ticker（而不是3921个）
   - 可能导致某些统计计算或模型训练不稳定

3. **特征分布变化**：
   - 不同ticker的特征分布可能不同
   - 只选择1/5的ticker可能导致特征分布偏斜

## 重新评估修复方案

### 原修复方案仍然有效

虽然日期范围完整，但：
1. **动态调整最小训练窗**仍然有用（如果某些fold数据不足）
2. **减少CV折数**仍然有用（确保每个fold有足够数据）
3. **安全检查**仍然必要（如果所有fold被跳过）

### 但可能需要额外考虑

1. **检查每个fold的样本数**：
   - 确保每个fold有足够的样本（不仅是日期数）
   - 可能需要检查每个fold的ticker数量

2. **调整数据要求**：
   - 不仅检查训练窗天数，还要检查样本数
   - 可能需要检查每个日期的样本数

## 建议

1. **保持现有修复**：动态调整最小训练窗和减少CV折数仍然有用

2. **添加样本数检查**：
   ```python
   # 不仅检查训练窗天数，还检查样本数
   if train_window_days < min_train_window_days or len(train_idx) < min_samples_per_fold:
       continue
   ```

3. **检查日志**：
   - 查看实际训练时每个fold的训练窗天数和样本数
   - 确认是否真的是训练窗不足导致的问题
