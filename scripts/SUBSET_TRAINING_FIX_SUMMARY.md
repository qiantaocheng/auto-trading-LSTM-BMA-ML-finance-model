# 子集训练挂起问题修复总结

## 问题根本原因

**发现**: 子集数据（1244个交易日）在6折CV中，前几个fold的训练窗 < 252天，导致所有fold被跳过，`oof_pred` 全0，后续Ridge Stacker训练挂起。

## 修复内容

### 1. 动态调整最小训练窗（Line 11426-11450）

**修改前**: 硬编码 `min_train_window_days = 252`

**修改后**: 
- 检测数据规模（唯一日期数）
- 子集数据（< 1500个交易日）: 降低到126天（半年）
- 全量数据（≥ 1500个交易日）: 保持252天（1年）

### 2. 添加安全检查（Line 11989-11996）

**新增**: 如果所有fold都被跳过，立即报错而不是继续执行：

```python
if len(scores_clean) == 0:
    raise ValueError("所有CV fold都被跳过！训练窗不足...")
```

### 3. 子集数据CV优化（Line 11113-11119）

**新增**: 子集数据自动减少CV折数（从6折到3折），确保每个fold有足够的训练数据。

## 预期效果

1. **子集数据**: 
   - 最小训练窗降低到126天
   - CV折数减少到3折
   - 每个fold有足够的训练数据

2. **全量数据**: 
   - 保持原有配置（252天，6折）
   - 不受影响

3. **错误处理**: 
   - 如果数据仍然不足，会明确报错而不是挂起
   - 错误信息包含数据统计信息

## 测试建议

1. **重新运行子集训练**:
   ```bash
   python scripts/train_and_eval_subset.py
   ```

2. **检查日志**:
   - 应该看到 "子集数据检测：唯一日期=1244，降低最小训练窗到126天"
   - 应该看到 "子集数据优化: 唯一日期=1244，调整CV参数 splits=3"
   - 不应该再挂起

3. **如果仍然失败**:
   - 检查日志中的错误信息
   - 可能需要进一步降低 `min_train_window_days` 或增加数据量
