# ä¸ºä»€ä¹ˆä¹‹å‰ä¼šæœ‰é‡å¤æ•°æ® - å®Œæ•´è§£é‡Š

## ğŸ” é—®é¢˜å›é¡¾

**ç°è±¡**: åŒä¸€ä¸ªtickeråœ¨åŒä¸€ä¸ªæ—¥æœŸå‡ºç°äº†å¤šæ¬¡é¢„æµ‹ï¼Œå¯¼è‡´Top20è¡¨æ ¼æ˜¾ç¤ºç›¸åŒè‚¡ç¥¨é‡å¤20æ¬¡ã€‚

**æ ¹æœ¬é—®é¢˜**: æ•°æ®æµä¸­äº§ç”Ÿäº†é‡å¤çš„(date, ticker)ç»„åˆã€‚

---

## ğŸ¯ å¯èƒ½çš„åŸå› ï¼ˆæŒ‰å¯èƒ½æ€§æ’åºï¼‰

### åŸå› 1: APIè¿”å›äº†åŒä¸€å¤©çš„å¤šæ¡è®°å½•ï¼ˆæœ€å¯èƒ½ï¼‰

**é—®é¢˜**: Polygon APIå¯èƒ½è¿”å›äº†åŒä¸€tickeråœ¨åŒä¸€å¤©çš„å¤šæ¡è®°å½•ï¼Œä½†æ—¶é—´æˆ³ä¸åŒã€‚

**ç¤ºä¾‹**:
```python
# APIè¿”å›:
#   2024-01-15 09:30:00, AAPL, Close=150.0, Volume=1000000
#   2024-01-15 16:00:00, AAPL, Close=150.5, Volume=2000000  # åŒä¸€å¤©ï¼Œä¸åŒæ—¶é—´

# æ—¥æœŸæ ‡å‡†åŒ–å:
compute_data['date'] = pd.to_datetime(compute_data['date']).dt.normalize()
#   2024-01-15, AAPL, Close=150.0
#   2024-01-15, AAPL, Close=150.5  # é‡å¤çš„(date, ticker)ç»„åˆï¼
```

**ä¸ºä»€ä¹ˆå‘ç”Ÿ**:
- Polygon APIçš„`timespan='day'`åº”è¯¥åªè¿”å›æ¯å¤©ä¸€æ¡è®°å½•ï¼ˆé€šå¸¸æ˜¯æ”¶ç›˜æ•°æ®ï¼‰
- ä½†APIå¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹è¿”å›å¤šæ¡è®°å½•ï¼š
  - æ•°æ®æ›´æ–°å¯¼è‡´é‡å¤
  - API bugè¿”å›é‡å¤æ•°æ®
  - ä¸åŒæ—¶é—´ç‚¹çš„å¿«ç…§æ•°æ®

**å½±å“**:
- `normalize()`å°†ä¸åŒæ—¶é—´æˆ³æ ‡å‡†åŒ–ä¸ºåŒä¸€å¤©
- å¯¼è‡´åŒä¸€ä¸ª(date, ticker)ç»„åˆå‡ºç°å¤šæ¬¡
- æœ€ç»ˆäº§ç”Ÿé‡å¤çš„é¢„æµ‹

---

### åŸå› 2: æ•°æ®åˆå¹¶æ—¶äº§ç”Ÿé‡å¤

**é—®é¢˜**: åœ¨`fetch_market_data`ä¸­ï¼Œå¤šä¸ªDataFrameåˆå¹¶æ—¶å¯èƒ½äº§ç”Ÿé‡å¤ã€‚

**ä»£ç ä½ç½®**: `bma_models/simple_25_factor_engine.py` line ~253

```python
# å‡è®¾æœ‰ä¸¤ä¸ªDataFrameéƒ½åŒ…å«AAPLçš„æ•°æ®
df1 = pd.DataFrame({
    'Close': [150.0],
    'Volume': [1000000]
}, index=[pd.Timestamp('2024-01-15')])

df2 = pd.DataFrame({
    'Close': [150.5],
    'Volume': [2000000]
}, index=[pd.Timestamp('2024-01-15')])

# åˆå¹¶å
combined = pd.concat([df1, df2], ignore_index=False)
# combined.index = [2024-01-15, 2024-01-15]  # é‡å¤çš„ç´¢å¼•ï¼

# reset_index()å
combined = combined.reset_index()
# åˆ›å»º'Date'åˆ—ï¼Œä½†è¡Œæ•°ä»ç„¶æ˜¯2è¡Œ
# å¦‚æœä¸¤ä¸ªDataFrameéƒ½æœ‰ticker='AAPL'ï¼Œå°±ä¼šäº§ç”Ÿé‡å¤çš„(date, ticker)ç»„åˆ
```

**ä¸ºä»€ä¹ˆå‘ç”Ÿ**:
- å¦‚æœ`all_data`ä¸­çš„å¤šä¸ªDataFrameæœ‰é‡å çš„ç´¢å¼•
- `pd.concat(ignore_index=False)`ä¼šä¿ç•™æ‰€æœ‰ç´¢å¼•
- å¦‚æœåŒä¸€ä¸ªtickeråœ¨å¤šä¸ªDataFrameä¸­éƒ½å‡ºç°ï¼Œåˆå¹¶åä¼šæœ‰é‡å¤

**å½±å“**:
- åˆå¹¶åçš„æ•°æ®æœ‰é‡å¤çš„(date, ticker)ç»„åˆ
- åç»­å¤„ç†ä¼šä¿ç•™è¿™äº›é‡å¤

---

### åŸå› 3: æ—¥æœŸæ ‡å‡†åŒ–ä¸ä¼šæ¶ˆé™¤é‡å¤

**é—®é¢˜**: `dt.normalize()`åªæ˜¯æ ¼å¼åŒ–æ—¥æœŸï¼Œä¸ä¼šæ¶ˆé™¤é‡å¤ã€‚

**ä»£ç ä½ç½®**: `bma_models/simple_25_factor_engine.py` line ~346

```python
compute_data['date'] = pd.to_datetime(compute_data['date']).dt.normalize()
```

**ä¸ºä»€ä¹ˆå‘ç”Ÿ**:
- `normalize()`åªæ˜¯å°†æ—¶é—´æˆ³æ ‡å‡†åŒ–ä¸ºæ—¥æœŸï¼ˆå»æ‰æ—¶é—´éƒ¨åˆ†ï¼‰
- ä¾‹å¦‚ï¼š`2024-01-15 09:30:00` â†’ `2024-01-15`
- ä½†å¦‚æœåŸå§‹æ•°æ®æœ‰ä¸¤æ¡è®°å½•ï¼Œæ ‡å‡†åŒ–åä»ç„¶æ˜¯ä¸¤æ¡

**ç¤ºä¾‹**:
```python
# åŸå§‹æ•°æ®:
#   2024-01-15 09:30:00, AAPL, Close=150.0
#   2024-01-15 16:00:00, AAPL, Close=150.5

# normalize()å:
#   2024-01-15, AAPL, Close=150.0
#   2024-01-15, AAPL, Close=150.5  # ä»ç„¶æ˜¯ä¸¤æ¡è®°å½•ï¼
```

**å½±å“**:
- å¦‚æœè¾“å…¥æ•°æ®æœ‰é‡å¤ï¼Œæ ‡å‡†åŒ–åä»ç„¶æœ‰é‡å¤
- éœ€è¦æ˜¾å¼å»é‡æ‰èƒ½æ¶ˆé™¤

---

### åŸå› 4: æ²¡æœ‰å»é‡é€»è¾‘

**é—®é¢˜**: åœ¨æ•°æ®æµçš„å¤šä¸ªå…³é”®èŠ‚ç‚¹éƒ½æ²¡æœ‰å»é‡é€»è¾‘ã€‚

**ç¼ºå¤±çš„å»é‡ä½ç½®**:

1. **`fetch_market_data`è¿”å›å‰** - æ²¡æœ‰å»é‡
2. **`compute_data`åˆ›å»ºå** - æ²¡æœ‰å»é‡
3. **`compute_all_17_factors`è¿”å›å‰** - æ²¡æœ‰å»é‡
4. **è®¾ç½®MultiIndexå** - æ²¡æœ‰å»é‡

**ä¸ºä»€ä¹ˆå‘ç”Ÿ**:
- ä»£ç å‡è®¾APIæ¯å¤©åªè¿”å›ä¸€æ¡è®°å½•
- ä»£ç å‡è®¾æ•°æ®åˆå¹¶ä¸ä¼šäº§ç”Ÿé‡å¤
- æ²¡æœ‰é˜²å¾¡æ€§ç¼–ç¨‹ï¼ˆdefensive programmingï¼‰

**å½±å“**:
- å¦‚æœä»»ä½•ç¯èŠ‚äº§ç”Ÿé‡å¤ï¼Œéƒ½ä¼šä¼ é€’åˆ°åç»­ç¯èŠ‚
- æœ€ç»ˆå¯¼è‡´é‡å¤çš„é¢„æµ‹

---

### åŸå› 5: å‘¨æœ«/å‡æœŸæ•°æ®ï¼ˆä¸å¤ªå¯èƒ½ç›´æ¥å¯¼è‡´é‡å¤ï¼‰

**é—®é¢˜**: è™½ç„¶å‘¨æœ«/å‡æœŸæ•°æ®ä¸ä¼šç›´æ¥å¯¼è‡´é‡å¤ï¼Œä½†å¯èƒ½é—´æ¥å½±å“ã€‚

**ä¸ºä»€ä¹ˆä¸å¤ªå¯èƒ½**:
- å‘¨æœ«å’Œå‡æœŸæ˜¯**ä¸åŒçš„æ—¥æœŸ**ï¼Œä¸ä¼šäº§ç”Ÿé‡å¤çš„(date, ticker)ç»„åˆ
- ä¾‹å¦‚ï¼š`2024-01-13`ï¼ˆå‘¨å…­ï¼‰å’Œ`2024-01-15`ï¼ˆå‘¨ä¸€ï¼‰æ˜¯ä¸åŒçš„æ—¥æœŸ

**ä½†å¯èƒ½é—´æ¥å½±å“**:
- å¦‚æœAPIè¿”å›äº†å‘¨æœ«æ•°æ®ï¼Œå¯èƒ½å½±å“æ•°æ®è´¨é‡
- å¦‚æœæ•°æ®åŒ…å«å‘¨æœ«ï¼Œå¯èƒ½å½±å“å› å­è®¡ç®—

---

### åŸå› 6: æ²¡æœ‰æ”¶ç›˜ä»·çš„æ•°æ®è¢«åŒ…å«ï¼ˆå¯èƒ½å¯¼è‡´é—®é¢˜ï¼‰

**é—®é¢˜**: å¦‚æœæŸäº›tickeråœ¨æŸä¸€å¤©æ²¡æœ‰æ”¶ç›˜ä»·ï¼Œè¿™äº›è®°å½•å¯èƒ½è¢«åŒ…å«ã€‚

**ä¸ºä»€ä¹ˆå‘ç”Ÿ**:
- ä»£ç æ²¡æœ‰è¿‡æ»¤æ‰æ²¡æœ‰æ”¶ç›˜ä»·çš„æ•°æ®
- å¦‚æœä»Šå¤©æ˜¯äº¤æ˜“æ—¥ä½†è¿˜æ²¡æ”¶ç›˜ï¼Œå¯èƒ½åŒ…å«ä¸å®Œæ•´çš„æ•°æ®

**å½±å“**:
- ä¸å®Œæ•´çš„æ•°æ®å¯èƒ½å¯¼è‡´é—®é¢˜
- è™½ç„¶ä¸æ˜¯ç›´æ¥å¯¼è‡´é‡å¤ï¼Œä½†å¯èƒ½å½±å“æ•°æ®è´¨é‡

---

## ğŸ“Š æ•°æ®æµä¸­çš„é‡å¤äº§ç”Ÿç‚¹

### æ•°æ®æµè·¯å¾„

```
1. fetch_market_data()
   â†“ [å¯èƒ½äº§ç”Ÿé‡å¤: APIè¿”å›å¤šæ¡è®°å½•]
2. market_data (å¯èƒ½æœ‰é‡å¤)
   â†“
3. compute_all_17_factors()
   â†“ [å¯èƒ½äº§ç”Ÿé‡å¤: æ•°æ®åˆå¹¶]
4. compute_data (å¯èƒ½æœ‰é‡å¤)
   â†“ [å¯èƒ½äº§ç”Ÿé‡å¤: æ—¥æœŸæ ‡å‡†åŒ–]
5. compute_data['date'].dt.normalize() (ä»ç„¶æœ‰é‡å¤)
   â†“ [æ²¡æœ‰å»é‡é€»è¾‘]
6. factors_df (æœ‰é‡å¤)
   â†“ [è®¾ç½®MultiIndex]
7. factors_df.index = MultiIndex(...) (é‡å¤çš„ç´¢å¼•)
   â†“ [æ²¡æœ‰å»é‡é€»è¾‘]
8. è¿”å› all_feature_data (æœ‰é‡å¤)
   â†“
9. predict_with_snapshot() (å¯¹æ¯ä¸ªé‡å¤ç´¢å¼•éƒ½äº§ç”Ÿé¢„æµ‹)
   â†“
10. Top20è¡¨æ ¼æ˜¾ç¤ºé‡å¤çš„è‚¡ç¥¨
```

---

## âœ… ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Ÿ

### ä¹‹å‰ï¼ˆè®­ç»ƒ/è¯„ä¼°ï¼‰

**æ•°æ®æº**: Parquetæ–‡ä»¶ï¼ˆ`polygon_factors_all_filtered_clean_final_v2.parquet`ï¼‰

**ç‰¹ç‚¹**:
- æ•°æ®å·²ç»é¢„å¤„ç†å’Œå»é‡
- æ¯ä¸ª(date, ticker)ç»„åˆåªå‡ºç°ä¸€æ¬¡
- å³ä½¿`compute_all_17_factors`æ²¡æœ‰å»é‡ï¼Œè¾“å…¥æ•°æ®æœ¬èº«æ²¡æœ‰é‡å¤

**ç»“æœ**: ä¸ä¼šäº§ç”Ÿé‡å¤é¢„æµ‹ âœ…

### ç°åœ¨ï¼ˆDirect Predictï¼‰

**æ•°æ®æº**: Polygon APIå®æ—¶æ•°æ®

**ç‰¹ç‚¹**:
- APIå¯èƒ½è¿”å›é‡å¤æ•°æ®
- æ•°æ®åˆå¹¶å¯èƒ½äº§ç”Ÿé‡å¤
- æ²¡æœ‰å»é‡é€»è¾‘

**ç»“æœ**: äº§ç”Ÿé‡å¤é¢„æµ‹ âŒ

---

## ğŸ¯ æ ¹æœ¬åŸå› æ€»ç»“

**ä¸ºä»€ä¹ˆä¼šæœ‰é‡å¤æ•°æ®ï¼Ÿ**

**ç­”æ¡ˆ**: **å¤šä¸ªç¯èŠ‚éƒ½å¯èƒ½äº§ç”Ÿé‡å¤ï¼Œè€Œä»£ç ä¸­æ²¡æœ‰å»é‡é€»è¾‘**

**ä¸»è¦åŸå› **:
1. **APIè¿”å›äº†åŒä¸€å¤©çš„å¤šæ¡è®°å½•**ï¼ˆä¸åŒæ—¶é—´æˆ³ï¼‰â†’ æ ‡å‡†åŒ–åå˜æˆé‡å¤
2. **æ•°æ®åˆå¹¶æ—¶äº§ç”Ÿäº†é‡å¤** â†’ `pd.concat`ä¿ç•™äº†é‡å çš„ç´¢å¼•
3. **æ—¥æœŸæ ‡å‡†åŒ–ä¸ä¼šæ¶ˆé™¤é‡å¤** â†’ åªæ˜¯æ ¼å¼åŒ–ï¼Œä¸æ”¹å˜è¡Œæ•°
4. **æ²¡æœ‰å»é‡é€»è¾‘** â†’ ä»»ä½•ç¯èŠ‚çš„é‡å¤éƒ½ä¼šä¼ é€’åˆ°åç»­ç¯èŠ‚

**æ¬¡è¦åŸå› **:
5. **å‘¨æœ«/å‡æœŸæ•°æ®** â†’ è™½ç„¶ä¸ä¼šç›´æ¥å¯¼è‡´é‡å¤ï¼Œä½†å¯èƒ½å½±å“æ•°æ®è´¨é‡
6. **æ²¡æœ‰æ”¶ç›˜ä»·çš„æ•°æ®** â†’ è™½ç„¶ä¸ä¼šç›´æ¥å¯¼è‡´é‡å¤ï¼Œä½†å¯èƒ½å½±å“æ•°æ®è´¨é‡

---

## âœ… å·²å®æ–½çš„ä¿®å¤

### ä¿®å¤1: è¿‡æ»¤å‘¨æœ«æ•°æ®

**ä½ç½®**: `bma_models/simple_25_factor_engine.py` line ~352

```python
# Filter out weekend data (Saturday=5, Sunday=6)
compute_data['weekday'] = compute_data['date'].dt.dayofweek
weekend_count = (compute_data['weekday'].isin([5, 6])).sum()
if weekend_count > 0:
    compute_data = compute_data[~compute_data['weekday'].isin([5, 6])]
```

### ä¿®å¤2: è¿‡æ»¤æ²¡æœ‰æ”¶ç›˜ä»·çš„æ•°æ®

**ä½ç½®**: `bma_models/simple_25_factor_engine.py` line ~360

```python
# Only consider days with close prices (T-1 or T-0)
compute_data = compute_data[
    compute_data[close_col].notna() & 
    (compute_data[close_col] > 0)
]
```

### ä¿®å¤3: å»é‡é€»è¾‘

**ä½ç½®**: `bma_models/simple_25_factor_engine.py` line ~365

```python
# Remove duplicate (date, ticker) combinations
duplicates = compute_data.duplicated(subset=['date', 'ticker'], keep='last')
if duplicates.any():
    compute_data = compute_data[~duplicates]
```

### ä¿®å¤4: MultiIndexå»é‡

**ä½ç½®**: `bma_models/simple_25_factor_engine.py` line ~572

```python
# Remove duplicate indices after setting MultiIndex
duplicates = factors_df.index.duplicated()
if duplicates.any():
    factors_df = factors_df[~duplicates]

# Ensure each (date, ticker) combination appears only once
factors_df = factors_df.groupby(level=['date', 'ticker']).first()
```

---

## ğŸ¯ æ€»ç»“

**ä¸ºä»€ä¹ˆä¹‹å‰ä¼šæœ‰é‡å¤æ•°æ®ï¼Ÿ**

**ç­”æ¡ˆ**: 
1. **APIå¯èƒ½è¿”å›äº†åŒä¸€å¤©çš„å¤šæ¡è®°å½•**ï¼ˆä¸åŒæ—¶é—´æˆ³ï¼‰
2. **æ•°æ®åˆå¹¶æ—¶äº§ç”Ÿäº†é‡å¤**
3. **æ—¥æœŸæ ‡å‡†åŒ–ä¸ä¼šæ¶ˆé™¤é‡å¤**
4. **ä»£ç ä¸­æ²¡æœ‰å»é‡é€»è¾‘**

**è§£å†³æ–¹æ¡ˆ**:
- âœ… è¿‡æ»¤å‘¨æœ«æ•°æ®
- âœ… è¿‡æ»¤æ²¡æœ‰æ”¶ç›˜ä»·çš„æ•°æ®
- âœ… åœ¨å¤šä¸ªå…³é”®èŠ‚ç‚¹æ·»åŠ å»é‡é€»è¾‘
- âœ… ç¡®ä¿æ¯ä¸ª(date, ticker)ç»„åˆåªå‡ºç°ä¸€æ¬¡

**æ•ˆæœ**:
- âœ… é¿å…ä½¿ç”¨ä¸å®Œæ•´çš„æ•°æ®
- âœ… ç¡®ä¿æ•°æ®å”¯ä¸€æ€§
- âœ… æé«˜é¢„æµ‹å‡†ç¡®æ€§

---

**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

**ä¸‹ä¸€æ­¥**: è¿è¡ŒDirect Predictï¼ŒéªŒè¯ä¿®å¤æ•ˆæœ
