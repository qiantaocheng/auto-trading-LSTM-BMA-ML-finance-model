# OBV_DIVERGENCE MultiIndex é—®é¢˜å¯¹æ•°æ®å‡†ç¡®æ€§çš„å½±å“åˆ†æ

## é—®é¢˜åœºæ™¯

### å½“å‰ä»£ç æµç¨‹

1. **æ•°æ®å‡†å¤‡** (Line 342):
   ```python
   compute_data = compute_data.sort_values(['ticker', 'date']).reset_index(drop=True)
   ```
   - `data.index` = **RangeIndex** [0, 1, 2, ..., n-1]
   - æ•°æ®æŒ‰ `(ticker, date)` æ’åº

2. **å› å­è®¡ç®—å¤±è´¥** (Line 1357):
   ```python
   out['obv_divergence'] = np.zeros(len(data))  # numpy array [0, 0, 0, ..., 0]
   ```

3. **DataFrame åˆ›å»º** (Line 1411):
   ```python
   return pd.DataFrame(out, index=data.index)
   ```
   - pandas ä¼š**æŒ‰ä½ç½®å¯¹é½** numpy array
   - å› ä¸ºéƒ½æ˜¯ RangeIndexï¼Œ**åº”è¯¥èƒ½æ­£ç¡®å¯¹é½**

4. **å› å­åˆå¹¶** (Line 601):
   ```python
   factors_df = pd.concat(all_factors, axis=1)
   ```
   - å¦‚æœæ‰€æœ‰ DataFrame çš„ index éƒ½æ˜¯ RangeIndexï¼Œåˆå¹¶æˆåŠŸ

5. **MultiIndex è®¾ç½®** (Line 607-610):
   ```python
   factors_df.index = pd.MultiIndex.from_arrays(
       [compute_data['date'], compute_data['ticker']], 
       names=['date', 'ticker']
   )
   ```
   - **å…³é”®**: è¿™é‡Œä½¿ç”¨ `compute_data['date']` å’Œ `compute_data['ticker']` åˆ›å»º MultiIndex
   - è¿™äº›åˆ—çš„é¡ºåºä¸ `compute_data.index` ä¸€è‡´
   - å¦‚æœ `factors_df` çš„ index ä¹Ÿæ˜¯ RangeIndex [0, 1, 2, ...]ï¼Œ**åº”è¯¥èƒ½æ­£ç¡®å¯¹é½**

## æ•°æ®å‡†ç¡®æ€§å½±å“åˆ†æ

### âœ… **ç†è®ºä¸Šåº”è¯¥æ²¡é—®é¢˜**

**åŸå› **ï¼š
1. `data.index` æ˜¯ **RangeIndex** [0, 1, 2, ..., n-1]
2. `np.zeros(len(data))` ä¹Ÿæ˜¯æŒ‰ä½ç½® [0, 1, 2, ..., n-1]
3. `pd.DataFrame(out, index=data.index)` ä¼š**æŒ‰ä½ç½®å¯¹é½**
4. MultiIndex è®¾ç½®æ—¶ä½¿ç”¨ `compute_data['date']` å’Œ `compute_data['ticker']`ï¼Œé¡ºåºä¸ RangeIndex ä¸€è‡´

**ç»“è®º**: ç†è®ºä¸Šï¼Œnumpy array åº”è¯¥èƒ½æ­£ç¡®å¯¹é½åˆ° MultiIndex

### âš ï¸ **ä½†å¯èƒ½å­˜åœ¨æ½œåœ¨é—®é¢˜**

#### é—®é¢˜ 1: æ•°æ®é¡ºåºä¸ä¸€è‡´
å¦‚æœ `compute_data` åœ¨æŸä¸ªåœ°æ–¹è¢«é‡æ–°æ’åºæˆ–è¿‡æ»¤ï¼š
- `factors_df.index` çš„é¡ºåºå¯èƒ½ä¸ `compute_data['date']` å’Œ `compute_data['ticker']` çš„é¡ºåºä¸ä¸€è‡´
- å¯¼è‡´ MultiIndex è®¾ç½®æ—¶ï¼Œnumpy array çš„å€¼è¢«åˆ†é…åˆ°é”™è¯¯çš„è¡Œ

#### é—®é¢˜ 2: åˆ—ä¸¢å¤±
å¦‚æœå¯¹é½å¤±è´¥ï¼Œ`obv_divergence` åˆ—å¯èƒ½ï¼š
- å®Œå…¨ä¸¢å¤±ï¼ˆä¸åœ¨ DataFrame ä¸­ï¼‰
- å€¼å…¨éƒ¨ä¸º NaN
- å€¼é¡ºåºé”™è¯¯

#### é—®é¢˜ 3: åç»­å¤„ç†
å¦‚æœ `obv_divergence` åˆ—å­˜åœ¨ä½†å€¼ä¸æ­£ç¡®ï¼š
- æ¨¡å‹è®­ç»ƒæ—¶ä¼šä½¿ç”¨é”™è¯¯çš„å€¼
- å¯èƒ½å¯¼è‡´æ¨¡å‹æ€§èƒ½ä¸‹é™
- ä½†å› ä¸ºæœ‰åˆ«åæ˜ å°„ï¼ˆ`obv_divergence` â†’ `obv_momentum_40d`ï¼‰ï¼Œå¯èƒ½ä¸ä¼šç›´æ¥ä½¿ç”¨

## å®é™…å½±å“è¯„ä¼°

### ğŸ”´ **é«˜é£é™©åœºæ™¯**

1. **å¦‚æœ `obv_divergence` è®¡ç®—å¤±è´¥**:
   - ä½¿ç”¨ `np.zeros(len(data))` å¡«å……
   - å¦‚æœå¯¹é½å¤±è´¥ï¼Œåˆ—å¯èƒ½ä¸¢å¤±
   - **å½±å“**: æ¨¡å‹æ— æ³•ä½¿ç”¨ `obv_divergence`ï¼Œä¼šä½¿ç”¨åˆ«åæ˜ å°„åˆ° `obv_momentum_40d`
   - **æ•°æ®å‡†ç¡®æ€§**: âš ï¸ **å¯èƒ½å—å½±å“**ï¼ˆå¦‚æœæ¨¡å‹æœŸæœ›ä½¿ç”¨ `obv_divergence` ä½†å®é™…ä½¿ç”¨äº† `obv_momentum_40d`ï¼‰

2. **å¦‚æœå¯¹é½å¤±è´¥ä½†åˆ—å­˜åœ¨**:
   - å€¼å¯èƒ½å…¨éƒ¨ä¸º 0ï¼ˆè¿™æ˜¯é¢„æœŸçš„ï¼‰
   - ä½†å¦‚æœå€¼é¡ºåºé”™è¯¯ï¼Œ**æ•°æ®å‡†ç¡®æ€§ä¼šå—å½±å“**
   - **å½±å“**: ğŸ”´ **é«˜é£é™©** - é”™è¯¯çš„å› å­å€¼ä¼šå¯¼è‡´é”™è¯¯çš„é¢„æµ‹

### ğŸŸ¡ **ä¸­ç­‰é£é™©åœºæ™¯**

1. **å¦‚æœ `obv_divergence` è®¡ç®—æˆåŠŸ**:
   - ä½¿ç”¨ Seriesï¼Œæœ‰æ­£ç¡®çš„ index
   - **æ•°æ®å‡†ç¡®æ€§**: âœ… **ä¸å—å½±å“**

2. **å¦‚æœå¯¹é½æˆåŠŸä½†å€¼å…¨ä¸º 0**:
   - è¿™æ˜¯é¢„æœŸçš„ï¼ˆè®¡ç®—å¤±è´¥æ—¶çš„é»˜è®¤å€¼ï¼‰
   - **æ•°æ®å‡†ç¡®æ€§**: âœ… **ä¸å—å½±å“**ï¼ˆå› ä¸ºå€¼æœ¬èº«å°±æ˜¯ 0ï¼‰

### âœ… **ä½é£é™©åœºæ™¯**

1. **å¦‚æœä½¿ç”¨åˆ«åæ˜ å°„**:
   - `obv_divergence` â†’ `obv_momentum_40d`
   - å³ä½¿ `obv_divergence` ä¸¢å¤±ï¼Œä¹Ÿä¼šä½¿ç”¨ `obv_momentum_40d`
   - **æ•°æ®å‡†ç¡®æ€§**: âœ… **ä¸å—å½±å“**ï¼ˆæœ‰æ›¿ä»£æ–¹æ¡ˆï¼‰

## éªŒè¯æ–¹æ³•

### æ£€æŸ¥æ•°æ®å‡†ç¡®æ€§

1. **æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨**:
   ```python
   assert 'obv_divergence' in factors_df.columns
   ```

2. **æ£€æŸ¥å€¼æ˜¯å¦æ­£ç¡®**:
   ```python
   # å¦‚æœè®¡ç®—å¤±è´¥ï¼Œå€¼åº”è¯¥å…¨ä¸º 0
   if obv_divergence_computation_failed:
       assert (factors_df['obv_divergence'] == 0).all()
   ```

3. **æ£€æŸ¥ index å¯¹é½**:
   ```python
   # æ£€æŸ¥ obv_divergence çš„ index æ˜¯å¦ä¸å…¶ä»–å› å­ä¸€è‡´
   assert factors_df['obv_divergence'].index.equals(factors_df['obv_momentum_60d'].index)
   ```

4. **æ£€æŸ¥å€¼é¡ºåº**:
   ```python
   # æ£€æŸ¥ obv_divergence çš„å€¼æ˜¯å¦ä¸å¯¹åº”çš„ ticker/date åŒ¹é…
   # å¦‚æœå¯¹é½å¤±è´¥ï¼Œå€¼å¯èƒ½ä¼šé”™ä½
   ```

## ç»“è®º

### ğŸ”´ **å¯èƒ½å½±å“æ•°æ®å‡†ç¡®æ€§**

**åŸå› **ï¼š
1. **å¦‚æœå¯¹é½å¤±è´¥**: `obv_divergence` åˆ—å¯èƒ½ä¸¢å¤±æˆ–å€¼é¡ºåºé”™è¯¯
2. **å¦‚æœå€¼é¡ºåºé”™è¯¯**: ä¼šå¯¼è‡´é”™è¯¯çš„å› å­å€¼ï¼Œå½±å“æ¨¡å‹é¢„æµ‹
3. **å¦‚æœåˆ—ä¸¢å¤±**: æ¨¡å‹ä¼šä½¿ç”¨åˆ«åæ˜ å°„ï¼Œä½†å¯èƒ½ä¸è®­ç»ƒæ—¶ä¸ä¸€è‡´

### âœ… **ä¿®å¤åçš„æ•ˆæœ**

ä¿®å¤åï¼ˆä½¿ç”¨ `pd.Series` è€Œä¸æ˜¯ `np.zeros`ï¼‰ï¼š
- âœ… ç¡®ä¿ index æ­£ç¡®å¯¹é½
- âœ… å³ä½¿è®¡ç®—å¤±è´¥ï¼Œä¹Ÿèƒ½æ­£ç¡®å¡«å……é»˜è®¤å€¼
- âœ… åœ¨ MultiIndex è®¾ç½®åä»ç„¶ä¿æŒæ­£ç¡®çš„å¯¹é½
- âœ… **æ•°æ®å‡†ç¡®æ€§å¾—åˆ°ä¿éšœ**

## å»ºè®®

**å¼ºçƒˆå»ºè®®ä¿®å¤**ï¼Œå› ä¸ºï¼š
1. **æ•°æ®å‡†ç¡®æ€§**: ç¡®ä¿å› å­å€¼æ­£ç¡®å¯¹é½åˆ°å¯¹åº”çš„ (date, ticker) ç»„åˆ
2. **ä»£ç å¥å£®æ€§**: å³ä½¿è®¡ç®—å¤±è´¥ï¼Œä¹Ÿèƒ½æ­£ç¡®å¤„ç†
3. **ä¸€è‡´æ€§**: ä¸å…¶ä»–å› å­çš„å¤„ç†æ–¹å¼ä¸€è‡´
4. **å¯ç»´æŠ¤æ€§**: ä»£ç æ›´æ¸…æ™°ï¼Œæ›´å®¹æ˜“ç†è§£
