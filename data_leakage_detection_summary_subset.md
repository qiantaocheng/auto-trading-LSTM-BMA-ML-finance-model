# 80/20 OOF 数据泄露检测实验报告（子集数据）

## 实验信息

- **数据文件**: `data/factor_exports/polygon_factors_all_filtered_clean_final_v2_subset_1_5_tickers.parquet`
- **数据规模**: 827,900 样本，1,244 个唯一日期
- **时间分割**: 
  - 训练集: 2021-01-19 至 2024-12-16 (985 个日期，637,452 样本)
  - 测试集: 2025-01-02 至 2025-12-30 (249 个日期，183,424 样本)
  - Purge gap: 10 天
- **实验时间**: 2026-01-23 01:14:58

---

## 实验结果汇总

| 实验 | 状态 | 泄露检测 | 说明 |
|------|------|---------|------|
| **实验1: 随机打乱目标变量** | ✅ 通过 | ❌ 未检测到 | 随机目标变量相关性 = 0.000092 (正常) |
| **实验2: 特征标准化泄露** | ⚠️ **警告** | ✅ **检测到** | 标准化差异较大，可能存在泄露 |
| **实验3: CV时间顺序** | ❌ 失败 | - | 无法导入bma_models模块 |
| **实验4: 目标变量未来信息** | ✅ 通过 | ❌ 未检测到 | 目标变量分布正常 |

**总体泄露率**: 25.0% (1/4 个可运行实验检测到泄露)

---

## 详细结果

### 实验1: 随机打乱目标变量检测 ✅

**原理**: 如果OOF预测存在数据泄露，即使目标变量被随机打乱，OOF预测仍可能显示高相关性。

**结果**:
- 真实目标 vs 预测: IC = -0.006212
- 随机目标 vs 预测: IC = 0.000092
- 差异: 0.006304

**结论**: ✅ **未检测到泄露**
- 随机目标变量的相关性接近0，说明OOF预测没有使用测试集信息
- 真实目标变量的相关性也很低（-0.006212），这是正常的，因为使用的是简单的线性组合作为代理预测

---

### 实验2: 特征标准化泄露检测 ⚠️

**原理**: 特征标准化应该只使用训练集统计量，不应该使用测试集统计量。

**结果**:
- 训练集标准化均值差异: **0.006684**
- 训练集标准化标准差差异: **0.037701**

**结论**: ⚠️ **检测到潜在泄露**
- 标准化差异超过了阈值（0.01）
- **建议检查**: 特征标准化是否只使用训练集统计量

**可能的原因**:
1. 特征标准化时使用了训练+测试集的统计量
2. 特征工程阶段可能使用了测试集信息
3. 需要检查实际训练代码中的标准化逻辑

**修复建议**:
```python
# 正确做法：只使用训练集统计量
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)  # 只在训练集上fit
X_test_scaled = scaler.transform(X_test)        # 使用训练集的统计量transform测试集

# 错误做法：使用训练+测试集统计量
X_combined = pd.concat([X_train, X_test])
scaler = StandardScaler()
X_combined_scaled = scaler.fit_transform(X_combined)  # ❌ 泄露！
```

---

### 实验3: CV时间顺序检测 ❌

**状态**: 实验失败

**错误**: `No module named 'bma_models'`

**原因**: 脚本运行时无法导入bma_models模块，可能是因为：
- Python路径未正确设置
- 需要在项目根目录运行
- 或者需要安装/配置bma_models模块

**建议**: 
- 在项目根目录运行脚本
- 或者修改脚本以正确处理模块导入

---

### 实验4: 目标变量未来信息检测 ✅

**原理**: 目标变量应该只使用T+horizon_days的信息，不应该使用更未来的信息。

**结果**:
- 检查了100个日期的目标变量分布
- 异常值数量: 0/100
- 异常值比例: 0%

**结论**: ✅ **未检测到泄露**
- 目标变量分布正常，没有异常值
- 说明目标变量计算正确，没有使用未来信息

---

### 实验5: OOF vs 测试集性能比较

**状态**: 需要实际OOF预测数据

**说明**: 此实验需要运行80/20评估后才能进行，需要：
1. 运行80/20评估，获取OOF预测
2. 运行测试集预测
3. 比较两者的性能差异

**运行方法**:
```bash
# 1. 运行80/20评估
python scripts/time_split_80_20_oos_eval.py \
    --data-file data/factor_exports/polygon_factors_all_filtered_clean_final_v2_subset_1_5_tickers.parquet \
    --split 0.8 \
    --horizon-days 10

# 2. 比较OOF和测试集性能
python scripts/compare_oof_vs_test_performance.py \
    --snapshot-id <snapshot_id> \
    --test-predictions-file results/.../report_df.csv
```

---

## 关键发现

### ⚠️ 检测到的问题

1. **特征标准化泄露** (实验2)
   - 标准化差异较大（标准差差异 = 0.037701）
   - 可能存在使用测试集统计量进行标准化的情况
   - **需要立即检查并修复**

### ✅ 正常的部分

1. **随机目标变量检测** (实验1)
   - 随机目标变量相关性接近0，说明没有泄露

2. **目标变量未来信息** (实验4)
   - 目标变量分布正常，没有使用未来信息

---

## 修复建议

### 优先级1: 修复特征标准化泄露

**检查点**:
1. 检查训练代码中的特征标准化逻辑
2. 确保只使用训练集统计量
3. 验证测试集特征使用训练集的均值和标准差

**代码检查位置**:
- `bma_models/量化模型_bma_ultra_enhanced.py` - 特征标准化部分
- `scripts/time_split_80_20_oos_eval.py` - 测试集特征处理部分

### 优先级2: 修复实验3的模块导入问题

**建议**:
- 在项目根目录运行脚本
- 或者修改脚本添加sys.path设置

### 优先级3: 运行实验5

**建议**:
- 运行80/20评估获取OOF预测
- 然后运行OOF vs 测试集性能比较

---

## 结论

**总体评估**: ⚠️ **检测到潜在数据泄露**

- **泄露来源**: 特征标准化可能使用了测试集统计量
- **严重程度**: 中等（标准化差异不是特别大，但需要修复）
- **影响**: 可能导致模型评估结果过于乐观

**建议行动**:
1. ✅ **立即检查并修复特征标准化逻辑**
2. ✅ **重新运行实验验证修复效果**
3. ✅ **运行实验5进行完整验证**

---

**报告生成时间**: 2026-01-23
**报告文件**: `data_leakage_report_20260123_011500.json`
**日志文件**: `data_leakage_detection_20260123_011458.log`
