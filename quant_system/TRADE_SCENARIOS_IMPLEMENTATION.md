# 交易场景实现说明

## 概述

已实现5种不同的交易场景，每种场景有不同的持仓周期、盈利目标和退出规则。

## 场景分类

### 场景 A：失败的交易 (FAILED)
- **止损**: 7%
- **持仓周期**: 日内至5天
- **退出条件**:
  1. 触及7%止损
  2. 发生深蹲（>5%跌幅）且3天内无修复
  3. 放量跌破突破枢纽（成交量>1.5倍平均，价格下跌>2%）
- **结果**: 本金亏损
- **自动转换**: 如果持仓超过5天且盈利，自动转换为场景B (SWING)

### 场景 B：普通的波段盈利 (SWING)
- **目标盈利**: 20%-25%
- **持仓周期**: 2至6周（14-42天）
- **退出条件**:
  1. 在20%处遇到阻力（价格在20%目标附近震荡）
  2. 达到25%盈利
  3. 持仓超过6周
  4. 触及7%止损
- **结果**: 20%-25%盈利

### 场景 C：强力爆发（8周法则）(BREAKOUT)
- **进入条件**: 股票在3周内暴涨20%以上
- **持仓周期**: 至少8周（56天），随后无限期
- **退出条件**:
  1. 8周内：仅检查7%止损
  2. 8周后：如果股价跌破50日均线，则退出
  3. 否则：一直持有
- **结果**: 潜在的多倍股

### 场景 D：超级表现者 (SUPER_PERFORMER)
- **进入条件**: 股价在50日和200日均线上方，且50日均线在200日均线上方
- **目标盈利**: 100%以上
- **持仓周期**: 6至18个月（180-540天）
- **退出条件**:
  1. 有效跌破50日均线（价格<50MA * 0.97，即3%以下）
  2. 有效跌破200日均线（价格<200MA * 0.97，即3%以下）
  3. 持仓超过18个月
- **结果**: 100%以上盈利

### 场景 E：僵尸股 (ZOMBIE)
- **检测条件**: 持仓5天以上，价格波动<2%
- **持仓周期**: 5至10天
- **退出条件**:
  1. 触发"时间止损"：持仓5天以上且价格波动<2%
  2. 持仓超过10天（硬性限制）
- **结果**: 盈亏平衡或微利/微亏
- **自动检测**: 任何持仓5天以上且价格波动<2%的股票会被自动标记为ZOMBIE

## 技术实现

### 新增枚举类型
```python
class TradeScenario(Enum):
    FAILED = "A"
    SWING = "B"
    BREAKOUT = "C"
    SUPER_PERFORMER = "D"
    ZOMBIE = "E"
```

### Trade类新增字段
- `scenario`: 交易场景类型
- `max_price_since_entry`: 自开仓以来的最高价
- `min_price_since_entry`: 自开仓以来的最低价
- `days_since_20pct_gain`: 达到20%盈利后的天数（用于场景C）
- `last_significant_move_date`: 最后一次显著波动的日期（用于僵尸股检测）

### 新增辅助方法
1. `_calculate_moving_averages()`: 计算移动平均线（50日、200日）
2. `_check_volume_breakdown()`: 检测放量跌破
3. `_check_deep_squat()`: 检测深蹲且无修复
4. `_check_resistance_at_20pct()`: 检测20%阻力位
5. `_determine_trade_scenario()`: 在开仓时确定交易场景

### 退出逻辑重构
`_check_exits()` 方法已完全重写，根据不同的场景应用相应的退出规则。

## 使用示例

### 查看交易场景
在日志中，每个开仓和退出都会显示场景类型：
```
Opened position: AAPL 61 shares @ $161.78, stop: $153.06, signal: 0.583, scenario: B, cost: $9,869.68
Exit AAPL [B]: Resistance at 20.5% @ $195.00, P&L=$2,025.00
```

### 场景自动转换
- 场景A（失败交易）如果持仓超过5天且盈利，会自动转换为场景B
- 任何持仓5天以上且价格波动<2%的股票会被自动标记为场景E（僵尸股）

## 注意事项

1. **止损统一**: 所有场景都使用7%止损（场景A、B、C）
2. **移动平均线**: 场景C和D依赖50日和200日移动平均线，需要足够的历史数据
3. **成交量检测**: 场景A的放量跌破检测需要成交量数据
4. **时间计算**: 持仓天数基于交易日计算，不是自然日

## 未来改进

1. 可以添加更多场景检测逻辑
2. 可以优化移动平均线的计算方式
3. 可以添加更多技术指标来辅助场景判断
4. 可以添加场景转换的统计和报告
