# max_positions 参数说明

## ⚠️ 重要更新：独立回测模式

**系统现在使用独立股票回测模式**：每个股票独立运行回测，每个股票拥有自己独立的资金池。

在独立模式下：
- **`max_positions` 不再重要**：每个股票只持有自己，所以自动设置为 `max_positions=1`
- **没有持仓上限**：每个股票独立运行，不受其他股票影响
- **独立资金池**：每个股票使用自己的全部资金（`initial_capital`）

详见：`INDEPENDENT_STOCK_BACKTEST.md`

---

## 历史说明（组合回测模式）

以下内容适用于之前的组合回测模式，仅供参考：

## 作用

`max_positions` 限制**同时持仓的股票数量**，不是限制总交易数量。

## 工作原理

### 1. 开仓限制

```python
# 在 _generate_entries 中
available_slots = self.config.max_positions - len(portfolio.positions)
if available_slots <= 0:
    return  # 没有空位，不开新仓

# 只处理前 available_slots 个信号
for signal in signals[:available_slots]:
    # 开仓...
```

**示例：**
- `max_positions = 10`
- 当前持仓 3 个股票
- `available_slots = 10 - 3 = 7`
- 即使有 20 个信号，也只开 7 个新仓

### 2. 与"所有ticker"的关系

**使用所有ticker（3921个）时：**
- 扫描所有 3921 个股票生成信号
- 但最多同时持有 `max_positions` 个股票
- 当有股票退出时，空出位置，可以开新仓

**示例流程：**
```
Day 1: 扫描3921个股票，找到50个信号
       → 开仓前10个（max_positions=10）
       
Day 2: 当前持仓10个
       → 扫描3921个股票，找到30个信号
       → 但 available_slots = 0，不开新仓
       
Day 3: 2个股票退出（止损/时间限制）
       → 当前持仓8个
       → 扫描3921个股票，找到40个信号
       → available_slots = 2，开仓2个新股票
```

### 3. 与僵尸股180天检测的关系

**没有直接关系**，但会影响：

1. **持仓时间**：
   - 僵尸股可以持有180天（如果波动<2%）
   - 如果 `max_positions=10`，一个僵尸股可能占用一个位置180天
   - 这会影响其他信号的开仓机会

2. **资金效率**：
   - 如果僵尸股占用位置太久，可能错过更好的机会
   - 但180天检测可以更早发现并退出僵尸股（每30天检查一次）

3. **建议设置**：
   - 如果使用所有ticker（3921个），建议 `max_positions` 设置较大（如20-50）
   - 这样可以：
     - 分散风险
     - 提高资金利用率
     - 减少僵尸股占用位置的影响

## 参数建议

### 场景1：使用所有ticker（3921个）

**推荐设置：**
```bash
--max-positions 20  # 或更大（30-50）
```

**原因：**
- 信号多，需要更多仓位来捕捉机会
- 僵尸股180天检测可能占用位置，需要更多缓冲
- 分散风险，提高资金利用率

### 场景2：使用少量ticker（如3-10个）

**推荐设置：**
```bash
--max-positions 3  # 或更小
```

**原因：**
- 信号少，不需要太多仓位
- 集中资金，提高单笔交易影响

## 实际影响

### 对平均收益率的影响

**max_positions 较小（如3-5）：**
- ✅ 更集中，单笔交易影响大
- ❌ 可能错过机会
- ❌ 僵尸股占用位置影响大

**max_positions 较大（如20-50）：**
- ✅ 分散风险
- ✅ 捕捉更多机会
- ✅ 僵尸股影响相对较小
- ❌ 单笔交易影响小
- ❌ 需要更多资金

### 对交易数量的影响

**max_positions 不影响总交易数**，只影响：
- 同时持仓数量
- 开仓频率（有位置才能开新仓）

**总交易数取决于：**
- 信号数量
- 退出规则触发频率
- 回测时间长度

## 示例对比

### 设置1：max_positions = 3
```
总交易数：93笔
平均收益率：0.95%
同时持仓：最多3个
```

### 设置2：max_positions = 20（使用所有ticker）
```
总交易数：可能500+笔（更多信号）
平均收益率：可能不同（更多交易机会）
同时持仓：最多20个
```

## 总结

1. **max_positions** = 同时持仓数量限制
2. **使用所有ticker** = 扫描所有股票，但受max_positions限制
3. **僵尸股180天** = 可以持有更久，但会占用位置
4. **建议**：使用所有ticker时，设置较大的max_positions（20-50）
