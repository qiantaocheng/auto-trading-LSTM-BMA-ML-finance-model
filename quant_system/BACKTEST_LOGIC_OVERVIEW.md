# 回测逻辑概述

## 一、整体流程

```
数据准备 → 信号生成 → 场景判断 → 开仓 → 持仓管理 → 退出 → 结果统计
```

## 二、详细流程说明

### 1. 数据准备阶段

**输入数据：**
- 因子数据（Parquet文件）：包含多因子数据，MultiIndex格式 (date, ticker)
- OHLCV数据：从Polygon API获取或缓存，包含Open/High/Low/Close/Volume
- 基准数据：SPY等基准指数数据

**数据处理：**
- 合并因子数据和OHLCV数据
- 确保数据对齐（日期、股票代码）
- 转换为字典格式：`{symbol: DataFrame}`

### 2. 回测主循环

**时间范围：**
- 从`start_date`到`end_date`，按交易日迭代
- 前252天作为"预热期"，不进行交易（需要足够历史数据用于信号计算）

**每日流程：**

```
每个交易日：
├─ 获取当前价格（所有股票）
├─ 更新组合权益曲线
├─ 检查退出条件（_check_exits）
│   └─ 根据5种场景应用不同退出规则
└─ 检查是否调仓（_should_rebalance）
    └─ 如果调仓日：
        └─ 生成新信号并开仓（_generate_entries）
```

### 3. 信号生成

**信号扫描（scan_universe）：**
- 对每个股票计算复合信号分数（Composite Signal Score）
- 信号分数范围：[0, 1]
- 只选择分数 >= `min_signal_score`（默认0.5-0.6）的股票

**信号组成：**
- 技术分析分数
- 形态识别分数
- 基本面分数
- 加权组合成复合分数

### 4. 交易场景判断（_determine_trade_scenario）

在开仓时，根据股票的历史表现自动判断交易场景：

**场景C (BREAKOUT)：**
- 条件：3周内涨幅 >= 20%
- 特点：强力爆发，8周法则

**场景D (SUPER_PERFORMER)：**
- 条件：价格 > 50日均线 > 200日均线，且50日均线上升
- 特点：超级表现者，长期持有

**场景B (SWING)：**
- 默认场景：普通波段交易
- 特点：目标20-25%盈利，2-6周持仓

**场景A (FAILED)：**
- 初始5天内自动检测
- 如果触发止损/深蹲/放量跌破，标记为失败交易

**场景E (ZOMBIE)：**
- 持仓5天以上且价格波动 < 2%
- 自动检测并标记

### 5. 开仓逻辑（_generate_entries）

**市场环境检测：**
- 检测市场状态（牛市/中性/熊市）
- 根据市场状态设置最大仓位：
  - 牛市：90%
  - 中性：60%
  - 熊市：30%

**仓位计算：**
- 每只股票单独计算仓位
- 风险金额 = 当前组合权益 × 1%（固定风险比例）
- 根据止损价计算股数：`shares = risk_amount / (entry_price - stop_loss)`
- 应用限制：
  - 单只股票最大10%仓位
  - 不超过市场环境限制
  - 不超过可用现金

**止损设置：**
- 使用Chandelier Stop（吊灯止损）
- 基于ATR（平均真实波幅）计算

### 6. 持仓管理

**每日更新：**
- 更新最高价/最低价（用于追踪）
- 更新信号分数（如果可用）
- 更新持仓天数
- 更新未实现盈亏

**场景自动转换：**
- 场景A：如果持仓>5天且盈利 → 转为场景B
- 任何持仓：如果5天以上且波动<2% → 转为场景E

### 7. 退出逻辑（_check_exits）

根据5种场景应用不同的退出规则：

#### 场景A：失败的交易
- **7%止损**：价格 <= entry_price × 0.93
- **深蹲无修复**：跌幅>5%且3天内未恢复
- **放量跌破**：成交量>1.5倍平均 + 价格下跌>2%

#### 场景B：波段盈利
- **20%阻力**：达到20%盈利且在目标价附近震荡
- **25%盈利**：直接达到25%盈利
- **6周时间限制**：持仓超过42天
- **7%止损**：价格 <= entry_price × 0.93

#### 场景C：8周法则
- **8周内**：仅检查7%止损
- **8周后**：如果价格 < 50日均线 → 退出
- **否则**：继续持有

#### 场景D：超级表现者
- **跌破50日均线**：价格 < 50MA × 0.97（3%缓冲）
- **跌破200日均线**：价格 < 200MA × 0.97（3%缓冲）
- **18个月限制**：持仓超过540天

#### 场景E：僵尸股
- **时间止损**：持仓>=5天且价格波动<2%
- **硬性限制**：持仓>=10天

### 8. 结果统计

**核心指标：**

1. **平均收益率（Average Return Per Trade）** ⭐
   - 计算方式：所有完整交易（从买入到卖出）的收益率百分比平均值
   - 公式：`average_return = mean([trade.pnl_pct for trade in closed_trades])`
   - **这是核心指标：全部股票经过信号处理和交易逻辑后的平均收益率**

2. **总收益率（Total Return）**
   - 组合最终权益 / 初始资本 - 1

3. **年化收益率（Annualized Return）**
   - 考虑时间因素的年化收益

4. **风险指标：**
   - Sharpe比率
   - Sortino比率
   - 最大回撤（Max Drawdown）

5. **交易统计：**
   - 总交易数
   - 胜率（Win Rate）
   - 盈亏比（Profit Factor）

## 三、关键特性

### 1. 风险控制
- **固定风险比例**：每笔交易风险 = 组合权益 × 1%
- **动态仓位限制**：根据市场环境调整最大仓位
- **止损保护**：所有场景都有止损机制

### 2. 场景自适应
- **自动场景判断**：根据股票表现自动分类
- **场景转换**：持仓过程中可能转换场景
- **差异化退出**：不同场景应用不同退出规则

### 3. 执行模拟
- **滑点**：买入+0.1%，卖出-0.1%
- **手续费**：$0.005/股，最低$1
- **价格获取**：使用实际收盘价，如果当日无数据则用最近可用价格

### 4. 数据要求
- **历史数据**：至少需要252天历史数据用于信号计算
- **预热期**：前252天不交易，仅用于数据准备
- **数据对齐**：确保因子数据和OHLCV数据在日期和股票上对齐

## 四、输出结果

**最终输出包含：**

1. **关键统计摘要：**
   ```
   Total Trades: XX
   Average Return Per Trade: X.XX%  ← 核心指标
   Total Return: X.XX%
   Win Rate: X.XX%
   Final Equity: $XXX,XXX.XX
   ```

2. **完整报告：**
   - 收益率指标
   - 风险指标
   - 交易统计
   - 基准对比（Alpha, Beta, Information Ratio）

3. **权益曲线：**
   - 每日组合价值变化
   - 回撤曲线

## 五、设计理念

1. **信号驱动**：所有交易都基于信号分数，确保有明确的入场理由
2. **场景分类**：不同股票表现不同，需要不同的持仓策略
3. **风险优先**：每笔交易都有明确的风险控制
4. **市场适应**：根据市场环境动态调整仓位
5. **完整周期**：从信号买入到完全卖出，统计完整交易周期

## 六、注意事项

1. **数据质量**：确保因子数据和OHLCV数据质量，缺失数据会影响结果
2. **参数设置**：`min_signal_score`、仓位限制等参数需要根据实际情况调整
3. **市场环境**：市场环境检测基于基准指数，需要确保基准数据准确
4. **时间计算**：所有时间计算基于交易日，不是自然日
5. **部分退出**：当前实现不支持部分退出，所有退出都是全部卖出
